@model ExtendedPaging<SiteInstruction>
@{
    ViewBag.Title = "Site Instruction List";
}
<div class="container">@*  style="font-family:'Century Gothic'"> *@
    <div class="row mb-2 mt-5">
        <div class="col col-lg-6 col-md-6 col-sm-6 ">
            <h4>@ViewBag.Title</h4>
        </div>
        <div class="col col-lg-6 col-md-6 col-sm-6 ">
            <div class="row col">
                <div class="col col-8 ms-auto">
                    <select id="ProjectList" class="form-select form-select-sm">
                        <option value="" selected>Select Project</option>
                        @if (Model != null && Model.Projects != null)
                        {
                            @foreach (var name in Model.Projects)
                            {
                                <option value="@name.ProjCode">@name.ProjName</option>
                            }
                        }
                    </select>
                </div>
            </div>
            <div class="row d-flex ms-auto col-8 mt-1">
                <div class="col col-md-3 col-sm-2 align-content-center">
                    <select id="pageData" class="form-select form-select-sm">
                        <option value="10">10</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="1000">1000</option>
                    </select>
                </div>
                <div class="col col-md-8 col-sm-10 text-end">
                    <form asp-action="GetData" method="get">
                        <div class="input-group">
                            <input id="txtSearch" type="text" name="s" class="col-lg-4 col-sm-4  form-control form-control-sm" placeholder="Search"  />
                            @* <button id="btnSearch" type="submit" class="btn btn-sm-2  btn-primary" > Search</button> *@
                            <span id="btnSearch" class="btn-group-sm btn btn-sm btn-primary">
                                <i class="fa-solid fa-magnifying-glass"></i>
                            </span>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="row mb-2 ">
        @if (TempData["deletemessage"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show col-12" role="alert">
                <strong>Alert</strong> @TempData["deletemessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }
    </div>
    <table id="tbl_index" class="table table-responsive table-hover text-center mt-3" style="font-size:clamp(8px,4vw,12px)">
        <thead>
            <tr class="table" style="background-color:#6d72b3;color:white">
                <th width="30%">Project</th>
                <th width="15%">CM/PMI No.</th>
                <th width="15%">Asec/PMI No.</th>
                <th width="10%">Amount</th>
                <th width="10%">Status</th>
                <th width="10%">Date</th>
                <th width="10%">Action</th>
            </tr>
        </thead>
        <tbody id="tbody_site">
            @if (Model != null && Model.ListData != null && Model.ListData.Count() > 0)
            {
                foreach (var site in Model.ListData)
                {
                    <tr>
                        <td class="text-start">@site.ProjectName</td>
                        <td>@site.CMPMINumber</td>
                        <td>@site.AsecPMINumber</td>
                        <td>@(site.Amount?.ToString("#,0.00")) </td>
                        <td>@site.Status</td>
                        <td>@site.Date.ToString("MMM-dd-yyyy")</td>
                        @* <td><i class="fa-solid fa-pen fa-pen-to-square nav-link" style="font-size:20px; padding:0px"></i></td> *@
                        <td class="gap-3">
                            <i class="fa-solid fa-pen-to-square  nav-link" style="font-size:20px; padding:0px"></i>
                            <i class="fa-solid fa-circle-info nav-link" style="font-size:20px; padding:0px"></i>
                            <i class="fa-solid fa-trash-can nav-link" style="font-size:20px; padding:0px"></i>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
    <div class="d-flex justify-content-center">
        <ul class="pagination fw-bold" id="pagination">
        </ul>
    </div>
    @if (User.IsInRole("Admin") || User.IsInRole("Cost"))
    {
        <div>
            <div class="position-fixed bottom-0 end-0 m-4">
                <a class="btn" asp-controller="Site" asp-action="Create" title="Insert new Site">

                    <span id="InsertIcon" class="material-symbols-outlined opacity-50" style="font-size: 70px;">
                        add_circle
                    </span>
                </a>
            </div>
        </div>
    }
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function(){
        let urlsite = '/Site/GetData';
        let connection = new signalR.HubConnectionBuilder().withUrl("/contractHub").build();
        let DEFAULT_PAGE = 1;
        let DEFAULT_SIZE = 10;
        let keyWord = "";
        let isPaginating = false;

        connection.start().then(function () {
            connection.on("LoadSiteData", function () {
                console.log("Successfully Connected");
                LoadData(DEFAULT_PAGE);
            });
        }).catch(function (error) {
            LoadData(DEFAULT_PAGE);
            console.error("Connection start failed:", error);
        })
        $("#ProjectList").on('change',function(){
            keyWord = $(this).val();
            LoadData(DEFAULT_PAGE);
        })
        $("#pageData").on('change', function () {
            DEFAULT_SIZE = $(this).val();
            LoadData(DEFAULT_PAGE);
        })
        $('#btnSearch').on('click',function(){
            keyWord = $('#txtSearch').val();
            LoadData(DEFAULT_PAGE);
        })
        LoadData(DEFAULT_PAGE);
        function LoadData(page) {
        
            $.ajax({
                url: urlsite,
                method: "GET",
                data: {
                    keyWord: keyWord,
                    page: page, // Pass the current page
                    pageSize: DEFAULT_SIZE,
                },
                success: function (result) {
                    console.log(result);
                    let pl = '';
                    $.each(result.data, (k, v) => {
                        pl += `<tr>`
                            + `<td>${v.projectName}</td>`
                            + `<td>${v.cmpmiNumber}</td>`
                            + `<td>${v.asecPMINumber}</td>`
                            + `<td>${ReplaceNumberWithCommas((parseFloat(v.amount) || 0).toFixed(2))}</td>`
                            + `<td>${v.status}</td>`
                            + `<td>${(v.date).toString().split("T", 1)[0]}</td>`
                            + `<td class="grid gap-3">`
                            + `<a class="p-1" href="/Site/Detail?id=${v.cmSiteId}"><i class="fa-solid fa-pen-to-square nav-link" style="font-size:20px; padding:0px"></i></a>`
                            + `<a class="p-1" href="/Site/Edit?id=${v.cmSiteId}"><i class="fa-solid fa-circle-info  nav-link" style="font-size:20px; padding:0px"></i></a>`
                            + `<a class="p-1" href="/Site/Delete?id=${v.cmSiteId}" id="btnDelete"><i class="fa-solid fa-trash-can nav-link" style="font-size:20px; padding:0px"></i></a>`
                            + `</td>`
                            + `</tr>`;
                    });
                    isPaginating = false;
                    $('#tbody_site').html(pl);
                    Pagination(result.pageCurrent, result.numSize);
                },
                error: function (err) {
                    console.log(err);
                    isPaginating = false;
                }
            });
        }
        function Pagination(currentPage, totalPages) {
            var paginationHtml = '<ul class="pagination fw-bold">';

            paginationHtml += '<li class="page-item ' + (currentPage <= 10 ? "disabled" : "") + '">';
            paginationHtml += '<a class="page-link" href="#" data-page="' + (currentPage - 10) + '">&lt;&lt; Previous</a>';
            paginationHtml += '</li>';

            paginationHtml += '<li class="page-item ' + (currentPage <= 1 ? "disabled" : "") + '">';
            paginationHtml += '<a class="page-link" href="#" data-page="' + (currentPage - 1) + '">Previous</a>';
            paginationHtml += '</li>';

            paginationHtml += '<li class="page-item ' + (currentPage === totalPages ? "active" : "") + '">';
            paginationHtml += '<span class="page-link">' + currentPage + '</span>';
            paginationHtml += '</li>';

            paginationHtml += '<li class="page-item ' + (currentPage >= totalPages ? "disabled" : "") + '">';
            paginationHtml += '<a class="page-link" href="#" data-page="' + (currentPage + 1) + '">Next</a>';
            paginationHtml += '</li>';

            paginationHtml += '<li class="page-item ' + (currentPage + 9 >= totalPages ? "disabled" : "") + '">';
            paginationHtml += '<a class="page-link" href="#" data-page="' + (currentPage + 10) + '">Next >></a>';
            paginationHtml += '</li>';
            $('#pagination').html(paginationHtml);

            $('#pagination').on('click', 'a.page-link', function (e) {
                e.preventDefault();
                var newPage = parseInt($(this).data('page'));
                if (newPage !== currentPage) {
                    currentPage = newPage;
                    if (isPaginating) return;
                    isPaginating = true;
                    LoadData(currentPage);

                }
            });
        }
        $(document).on('click', '#btnDelete', function (e) {
            return window.confirm('Are you sure you want to delete this file?');
        });
        function ReplaceNumberWithCommas(value) {
            var n = value.split(".");
            n[0] = n[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            return n.join(".");
        }
    })
</script>

